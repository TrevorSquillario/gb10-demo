<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Tracker</title>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent:      #667eea;
            --accent2:     #764ba2;
            --bg:          #0f0f13;
            --surface:     #1a1a24;
            --surface2:    #22222f;
            --border:      #2e2e3f;
            --text:        #e8e8f0;
            --text-muted:  #888899;
            --green:       #22c55e;
            --panel-w:     320px;
        }

        html, body {
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app { display: flex; flex-direction: column; height: 100vh; width: 100vw; }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            height: 56px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            gap: 16px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: .02em;
        }

        .header-title .dot {
            width: 10px; height: 10px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 1.8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: .5; transform: scale(.7); }
        }

        .header-stats { display: flex; gap: 20px; }

        .stat-chip { display: flex; flex-direction: column; align-items: center; line-height: 1.2; }
        .stat-chip .val { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
        .stat-chip .lbl { font-size: .65rem; text-transform: uppercase; letter-spacing: .08em; color: var(--text-muted); }

        .tracker-badge {
            font-size: .7rem;
            padding: 3px 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 20px;
            font-weight: 600;
            letter-spacing: .05em;
            white-space: nowrap;
        }

        /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main { display: flex; flex: 1; overflow: hidden; }

        /* â”€â”€ Centre column (grid + VLM banner) â”€â”€â”€â”€â”€ */
        .center-col {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* â”€â”€ 2Ã—2 video grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .video-grid {
            flex: 1;
            min-height: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            background: var(--border);  /* gap colour */
        }

        /* Each quadrant */
        .quad {
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quad img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        /* Quadrant label badge */
        .quad-label {
            position: absolute;
            top: 6px;
            left: 8px;
            font-size: .6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .08em;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(0,0,0,.55);
            color: var(--text-muted);
            pointer-events: none;
            z-index: 2;
        }

        /* Unavailable overlay */
        .quad-unavailable {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--text-muted);
            font-size: .75rem;
        }

        .quad-unavailable .icon { font-size: 1.8rem; }

        /* â”€â”€ VLM banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .vlm-banner {
            flex-shrink: 0;
            padding: 10px 20px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-height: 52px;
        }

        .vlm-label {
            font-size: .6rem;
            text-transform: uppercase;
            letter-spacing: .1em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .vlm-text {
            font-size: .8rem;
            color: var(--text);
            text-align: center;
            max-width: 900px;
            line-height: 1.5;
            font-style: italic;
        }

        /* â”€â”€ Person panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .person-panel {
            width: var(--panel-w);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border-left: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .panel-header h2 {
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: .1em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .panel-header .badge {
            background: var(--accent);
            color: white;
            border-radius: 20px;
            padding: 1px 9px;
            font-size: .75rem;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .person-list {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .person-list::-webkit-scrollbar { width: 4px; }
        .person-list::-webkit-scrollbar-track { background: transparent; }
        .person-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* â”€â”€ Person card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .person-card {
            flex-shrink: 0;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: border-color .2s, transform .15s;
            animation: fadeIn .3s ease both;
        }

        .person-card:hover { border-color: var(--accent); transform: translateY(-1px); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .card-top {
            display: flex;
            gap: 10px;
            padding: 10px;
            align-items: flex-start;
        }

        .crop-wrap {
            width: 72px; height: 90px;
            flex-shrink: 0;
            border-radius: 8px;
            overflow: hidden;
            background: #111;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
        }

        .crop-wrap img {
            position: absolute;
            inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            display: none;
        }

        .crop-fallback {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--text-muted);
        }

        .card-info { flex: 1; min-width: 0; }

        .card-id { font-size: .9rem; font-weight: 700; color: var(--accent); margin-bottom: 6px; }

        .attr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 6px; }

        .attr-row .key  { color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; font-size: .62rem; }
        .attr-row .val  { font-weight: 600; color: var(--text); font-size: .72rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .emotion-bar-wrap { padding: 0 10px 10px; }
        .emotion-label    { font-size: .62rem; text-transform: uppercase; letter-spacing: .06em; color: var(--text-muted); margin-bottom: 4px; }
        .emotion-pill     {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: .72rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
        }

        .analyzing {
            font-size: .72rem; color: var(--text-muted); font-style: italic;
            display: flex; align-items: center; gap: 6px;
        }

        .spinner {
            width: 10px; height: 10px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            flex-shrink: 0;
            animation: spin .7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-panel {
            flex: 1;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 10px;
            color: var(--text-muted); font-size: .82rem; text-align: center;
            padding: 20px;
        }
        .empty-panel .icon { font-size: 2.5rem; }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 900px) {
            html, body { overflow: auto; }
            .app { height: auto; min-height: 100vh; }
            .main { flex-direction: column; overflow: visible; }
            .video-grid { min-height: 50vw; }
            .person-panel { width: 100%; border-left: none; border-top: 1px solid var(--border); max-height: 420px; }
            header { flex-wrap: wrap; height: auto; padding: 10px 14px; gap: 10px; }
            .tracker-badge { display: none; }
        }

        @media (min-width: 1400px) { :root { --panel-w: 380px; } }
    </style>
</head>
<body>
<div class="app">

    <header>
        <div class="header-title">
            <span class="dot"></span>
            Person Tracker
        </div>
        <div class="header-stats">
            <div class="stat-chip">
                <span class="val" id="h-current">0</span>
                <span class="lbl">In Frame</span>
            </div>
            <div class="stat-chip">
                <span class="val" id="h-total">0</span>
                <span class="lbl">Total</span>
            </div>
            <div class="stat-chip">
                <span class="val" id="h-frames">0</span>
                <span class="lbl">Frames</span>
            </div>
        </div>
        <span class="tracker-badge">BoT-SORT Â· DeepFace Â· VLM</span>
    </header>

    <div class="main">

        <!-- â”€â”€ Centre column: 2Ã—2 grid + VLM banner â”€â”€ -->
        <div class="center-col">

            <div class="video-grid">

                <!-- Top-left: YOLO face detection -->
                <div class="quad">
                    <span class="quad-label">YOLO</span>
                    <img src="{{ url_for('video_feed') }}" alt="YOLO feed">
                </div>

                <!-- Top-right: StreamDiffusion V2 -->
                <div class="quad" id="quad-sd2">
                    <span class="quad-label">StreamDiffusion V2</span>
                    <img id="sd2-img" src="{{ url_for('sd2_feed') }}" alt="StreamDiffusion V2 feed"
                         onerror="document.getElementById('quad-sd2').classList.add('sd2-error')">
                    <div class="quad-unavailable" id="sd2-unavailable" style="display:none">
                        <span class="icon">ğŸ¬</span>
                        StreamDiffusion V2 not enabled
                    </div>
                </div>

                <!-- Bottom-left: Depth Anything -->
                <div class="quad" id="quad-depth">
                    <span class="quad-label">Depth Anything</span>
                    <img id="depth-img" src="{{ url_for('depth_feed') }}" alt="Depth feed"
                         onerror="document.getElementById('quad-depth').classList.add('depth-error')">
                    <div class="quad-unavailable" id="depth-unavailable" style="display:none">
                        <span class="icon">ğŸ“</span>
                        Depth engine not loaded
                    </div>
                </div>

                <!-- Bottom-right: DWpose -->
                <div class="quad" id="quad-dwpose">
                    <span class="quad-label">DWpose</span>
                    <img id="dwpose-img" src="{{ url_for('dwpose_feed') }}" alt="DWpose feed"
                         onerror="document.getElementById('quad-dwpose').classList.add('dwpose-error')">
                    <div class="quad-unavailable" id="dwpose-unavailable" style="display:none">
                        <span class="icon">ğŸ¦´</span>
                        DWpose not enabled
                    </div>
                </div>

            </div><!-- /.video-grid -->

            <!-- VLM description banner -->
            <div class="vlm-banner">
                <span class="vlm-label">VLM Â· Scene Description</span>
                <p class="vlm-text" id="vlm-text">Waiting for scene analysisâ€¦</p>
            </div>

        </div><!-- /.center-col -->

        <!-- â”€â”€ Right panel: DeepFace person cards â”€â”€ -->
        <aside class="person-panel">
            <div class="panel-header">
                <h2>Detected People</h2>
                <span class="badge" id="panel-count">0</span>
            </div>
            <div class="person-list" id="person-list">
                <div class="empty-panel">
                    <span class="icon">ğŸ‘¤</span>
                    Waiting for detectionsâ€¦
                </div>
            </div>
        </aside>

    </div><!-- /.main -->

</div><!-- /.app -->
<script>
    const EMOTION_EMOJI = {
        happy: 'ğŸ˜„', sad: 'ğŸ˜¢', angry: 'ğŸ˜ ',
        fear: 'ğŸ˜¨', surprise: 'ğŸ˜²', disgust: 'ğŸ¤¢', neutral: 'ğŸ˜',
    };
    const GENDER_EMOJI = { Man: 'â™‚', Woman: 'â™€' };

    const cards = {};   // track_id -> { lastRefresh }
    const knownIds = new Set();

    // â”€â”€ Show unavailable overlay when a feed 404s/503s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('sd2-img').addEventListener('error', () => {
        document.getElementById('sd2-img').style.display = 'none';
        document.getElementById('sd2-unavailable').style.display = 'flex';
    });
    document.getElementById('depth-img').addEventListener('error', () => {
        document.getElementById('depth-img').style.display = 'none';
        document.getElementById('depth-unavailable').style.display = 'flex';
    });
    document.getElementById('dwpose-img').addEventListener('error', () => {
        document.getElementById('dwpose-img').style.display = 'none';
        document.getElementById('dwpose-unavailable').style.display = 'flex';
    });

    // â”€â”€ Person card helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildCard(id) {
        const card = document.createElement('div');
        card.className = 'person-card';
        card.id = `card-${id}`;
        card.innerHTML = `
            <div class="card-top">
                <div class="crop-wrap">
                    <span class="crop-fallback" id="crop-fb-${id}">ğŸ‘¤</span>
                    <img id="crop-${id}" alt="Person ${id}"
                         onload="this.style.display='block'; document.getElementById('crop-fb-${id}').style.display='none'"
                         onerror="this.style.display='none'; document.getElementById('crop-fb-${id}').style.display='flex'" />
                </div>
                <div class="card-info">
                    <div class="card-id">Person ID ${id}</div>
                    <div class="attr-grid" id="attrs-${id}">
                        <div class="analyzing"><span class="spinner"></span> Analyzingâ€¦</div>
                    </div>
                </div>
            </div>
            <div class="emotion-bar-wrap" id="emotion-wrap-${id}" style="display:none">
                <div class="emotion-label">Dominant Emotion</div>
                <span class="emotion-pill" id="emotion-${id}"></span>
            </div>`;
        return card;
    }

    function updateCard(id, attrs) {
        const attrDiv = document.getElementById(`attrs-${id}`);
        if (!attrDiv) return;
        const age     = attrs.age     ?? 'â€”';
        const gender  = attrs.gender  ?? 'â€”';
        const race    = attrs.race    ?? 'â€”';
        const emotion = attrs.emotion ?? 'â€”';
        const gEmoji  = GENDER_EMOJI[gender] || '';
        attrDiv.innerHTML = `
            <div class="attr-row">
                <div class="key">Age</div>
                <div class="val">${age}</div>
            </div>
            <div class="attr-row">
                <div class="key">Gender</div>
                <div class="val">${gEmoji} ${gender}</div>
            </div>
            <div class="attr-row">
                <div class="key">Race</div>
                <div class="val">${race}</div>
            </div>`;
        const emoWrap = document.getElementById(`emotion-wrap-${id}`);
        const emoEl   = document.getElementById(`emotion-${id}`);
        if (emoWrap && emoEl) {
            const emo = EMOTION_EMOJI[emotion?.toLowerCase()] || 'ğŸ™‚';
            emoEl.textContent = `${emo} ${emotion}`;
            emoWrap.style.display = 'block';
        }
    }

    function refreshCrop(id) {
        const img = document.getElementById(`crop-${id}`);
        if (img) {
            const url = `/crop/${id}?t=${Date.now()}`;
            // Don't hide while loading â€” onload/onerror manage visibility
            img.src = url;
        }
    }

    // â”€â”€ Main polling loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function tick() {
        try {
            const [sRes, aRes, vRes] = await Promise.all([
                fetch('/stats'),
                fetch('/attributes'),
                fetch('/vlm'),
            ]);

            if (sRes.ok) {
                const stats = await sRes.json();
                document.getElementById('h-current').textContent = stats.current_people ?? 0;
                document.getElementById('h-total').textContent   = stats.total_tracked  ?? 0;
                document.getElementById('h-frames').textContent  = stats.frame_count    ?? 0;
            }

            if (aRes.ok) {
                const attrs   = await aRes.json();
                const attrIds = Object.keys(attrs).map(Number);
                const list    = document.getElementById('person-list');

                if (attrIds.length && list.querySelector('.empty-panel')) list.innerHTML = '';

                for (const id of attrIds) {
                    if (!knownIds.has(id)) {
                        knownIds.add(id);
                        list.prepend(buildCard(id));
                        cards[id] = { lastRefresh: 0 };
                    }
                }

                const now = Date.now();
                for (const id of attrIds) {
                    updateCard(id, attrs[id]);
                    if (cards[id] && now - cards[id].lastRefresh > 2000) {
                        refreshCrop(id);
                        cards[id].lastRefresh = now;
                    }
                }

                document.getElementById('panel-count').textContent = attrIds.length;
            }

            if (vRes.ok) {
                const vData = await vRes.json();
                const txt   = vData.description;
                if (txt) document.getElementById('vlm-text').textContent = txt;
            }

        } catch (e) { /* ignore transient errors */ }
    }

    tick();
    setInterval(tick, 2000);
</script>
</body>
</html>
