<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Tracker</title>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent:      #667eea;
            --accent2:     #764ba2;
            --bg:          #0f0f13;
            --surface:     #1a1a24;
            --surface2:    #22222f;
            --border:      #2e2e3f;
            --text:        #e8e8f0;
            --text-muted:  #888899;
            --green:       #22c55e;
            --panel-w:     320px;
        }

        html, body {
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app { display: flex; flex-direction: column; height: 100vh; width: 100vw; }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            height: 56px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            gap: 16px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: .02em;
        }

        .header-title .dot {
            width: 10px; height: 10px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 1.8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: .5; transform: scale(.7); }
        }

        .header-stats { display: flex; gap: 20px; }

        .stat-chip { display: flex; flex-direction: column; align-items: center; line-height: 1.2; }
        .stat-chip .val { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
        .stat-chip .lbl { font-size: .65rem; text-transform: uppercase; letter-spacing: .08em; color: var(--text-muted); }

        .tracker-badge {
            font-size: .7rem;
            padding: 3px 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 20px;
            font-weight: 600;
            letter-spacing: .05em;
            white-space: nowrap;
        }

        /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main { display: flex; flex: 1; overflow: hidden; }

        /* â”€â”€ Video â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .video-pane {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }

        .video-pane img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        /* â”€â”€ Person panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .person-panel {
            width: var(--panel-w);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border-left: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .panel-header h2 {
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: .1em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .panel-header .badge {
            background: var(--accent);
            color: white;
            border-radius: 20px;
            padding: 1px 9px;
            font-size: .75rem;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .person-list {
            flex: 1;
            min-height: 0;  /* critical: lets flex child shrink so overflow-y works */
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .person-list::-webkit-scrollbar { width: 4px; }
        .person-list::-webkit-scrollbar-track { background: transparent; }
        .person-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* â”€â”€ Person card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .person-card {
            flex-shrink: 0;  /* never compress cards â€” list scrolls instead */
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: border-color .2s, transform .15s;
            animation: fadeIn .3s ease both;
        }

        .person-card:hover { border-color: var(--accent); transform: translateY(-1px); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .card-top {
            display: flex;
            gap: 10px;
            padding: 10px;
            align-items: flex-start;
        }

        .crop-wrap {
            width: 72px; height: 90px;
            flex-shrink: 0;
            border-radius: 8px;
            overflow: hidden;
            background: #111;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
        }

        .crop-wrap img {
            position: absolute;
            inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            display: none;         /* hidden until first successful load */
        }

        .crop-fallback {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--text-muted);
        }

        .card-info { flex: 1; min-width: 0; }

        .card-id { font-size: .9rem; font-weight: 700; color: var(--accent); margin-bottom: 6px; }

        .attr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 6px; }

        .attr-row .key  { color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; font-size: .62rem; }
        .attr-row .val  { font-weight: 600; color: var(--text); font-size: .72rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .emotion-bar-wrap { padding: 0 10px 10px; }
        .emotion-label    { font-size: .62rem; text-transform: uppercase; letter-spacing: .06em; color: var(--text-muted); margin-bottom: 4px; }
        .emotion-pill     {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: .72rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
        }

        .analyzing {
            font-size: .72rem; color: var(--text-muted); font-style: italic;
            display: flex; align-items: center; gap: 6px;
        }

        .spinner {
            width: 10px; height: 10px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            flex-shrink: 0;
            animation: spin .7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-panel {
            flex: 1;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 10px;
            color: var(--text-muted); font-size: .82rem; text-align: center;
            padding: 20px;
        }
        .empty-panel .icon { font-size: 2.5rem; }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 800px) {
            html, body { overflow: auto; }
            .app { height: auto; min-height: 100vh; }
            .main { flex-direction: column; overflow: visible; }
            .video-pane { height: 56vw; min-height: 200px; }
            .person-panel { width: 100%; border-left: none; border-top: 1px solid var(--border); max-height: 420px; }
            header { flex-wrap: wrap; height: auto; padding: 10px 14px; gap: 10px; }
            .tracker-badge { display: none; }
        }

        @media (min-width: 1400px) { :root { --panel-w: 380px; } }
    </style>
</head>
<body>
<div class="app">

    <header>
        <div class="header-title">
            <span class="dot"></span>
            Person Tracker
        </div>
        <div class="header-stats">
            <div class="stat-chip">
                <span class="val" id="h-current">0</span>
                <span class="lbl">In Frame</span>
            </div>
            <div class="stat-chip">
                <span class="val" id="h-total">0</span>
                <span class="lbl">Total</span>
            </div>
            <div class="stat-chip">
                <span class="val" id="h-frames">0</span>
                <span class="lbl">Frames</span>
            </div>
        </div>
        <span class="tracker-badge">BoT-SORT Â· DeepFace</span>
    </header>

    <div class="main">
        <div class="video-pane">
            <img src="{{ url_for('video_feed') }}" alt="Live stream">
        </div>

        <aside class="person-panel">
            <div class="panel-header">
                <h2>Detected People</h2>
                <span class="badge" id="panel-count">0</span>
            </div>
            <div class="person-list" id="person-list">
                <div class="empty-panel">
                    <span class="icon">ðŸ‘¤</span>
                    Waiting for detectionsâ€¦
                </div>
            </div>
        </aside>
    </div>

</div>
<script>
    const EMOTION_EMOJI = {
        happy: 'ðŸ˜„', sad: 'ðŸ˜¢', angry: 'ðŸ˜ ',
        fear: 'ðŸ˜¨', surprise: 'ðŸ˜²', disgust: 'ðŸ¤¢', neutral: 'ðŸ˜',
    };
    const GENDER_EMOJI = { Man: 'â™‚', Woman: 'â™€' };

    const cards = {};   // track_id -> { lastRefresh }
    const knownIds = new Set();

    function buildCard(id) {
        const card = document.createElement('div');
        card.className = 'person-card';
        card.id = `card-${id}`;
        card.innerHTML = `
            <div class="card-top">
                <div class="crop-wrap">
                    <span class="crop-fallback" id="crop-fb-${id}">ðŸ‘¤</span>
                    <img id="crop-${id}" src="" alt="Person ${id}"
                         onload="this.style.display='block'; document.getElementById('crop-fb-${id}').style.display='none'"
                         onerror="this.style.display='none'; document.getElementById('crop-fb-${id}').style.display='flex'" />
                </div>
                <div class="card-info">
                    <div class="card-id">Person ID ${id}</div>
                    <div class="attr-grid" id="attrs-${id}">
                        <div class="analyzing"><span class="spinner"></span> Analyzingâ€¦</div>
                    </div>
                </div>
            </div>
            <div class="emotion-bar-wrap" id="emotion-wrap-${id}" style="display:none">
                <div class="emotion-label">Dominant Emotion</div>
                <span class="emotion-pill" id="emotion-${id}"></span>
            </div>`;
        return card;
    }

    function updateCard(id, attrs) {
        const attrDiv = document.getElementById(`attrs-${id}`);
        if (!attrDiv) return;
        const age     = attrs.age     ?? 'â€”';
        const gender  = attrs.gender  ?? 'â€”';
        const race    = attrs.race    ?? 'â€”';
        const emotion = attrs.emotion ?? 'â€”';
        const gEmoji  = GENDER_EMOJI[gender] || '';
        attrDiv.innerHTML = `
            <div class="attr-row">
                <div class="key">Age</div>
                <div class="val">${age}</div>
            </div>
            <div class="attr-row">
                <div class="key">Gender</div>
                <div class="val">${gEmoji} ${gender}</div>
            </div>
            <div class="attr-row">
                <div class="key">Race</div>
                <div class="val">${race}</div>
            </div>`;
        const emoWrap = document.getElementById(`emotion-wrap-${id}`);
        const emoEl   = document.getElementById(`emotion-${id}`);
        if (emoWrap && emoEl) {
            const emo = EMOTION_EMOJI[emotion?.toLowerCase()] || 'ðŸ™‚';
            emoEl.textContent = `${emo} ${emotion}`;
            emoWrap.style.display = 'block';
        }
    }

    function refreshCrop(id) {
        const img = document.getElementById(`crop-${id}`);
        if (img) {
            const url = `/crop/${id}?t=${Date.now()}`;
            // Reset display so onload/onerror fire correctly after src change
            img.style.display = 'none';
            img.src = url;
        }
    }

    async function tick() {
        try {
            const [sRes, aRes] = await Promise.all([fetch('/stats'), fetch('/attributes')]);
            if (!sRes.ok || !aRes.ok) return;
            const stats = await sRes.json();
            const attrs = await aRes.json();

            document.getElementById('h-current').textContent = stats.current_people ?? 0;
            document.getElementById('h-total').textContent   = stats.total_tracked  ?? 0;
            document.getElementById('h-frames').textContent  = stats.frame_count    ?? 0;

            // Panel shows only IDs that passed the DeepFace confidence gate
            // (i.e. have an entry in /attributes). Header stats still reflect
            // all YOLO-tracked IDs from /stats.
            const attrIds = Object.keys(attrs).map(Number);
            const list = document.getElementById('person-list');

            if (attrIds.length && list.querySelector('.empty-panel')) list.innerHTML = '';

            for (const id of attrIds) {
                if (!knownIds.has(id)) {
                    knownIds.add(id);
                    list.prepend(buildCard(id));
                    cards[id] = { lastRefresh: 0 };
                }
            }

            const now = Date.now();
            for (const id of attrIds) {
                updateCard(id, attrs[id]);
                if (cards[id] && now - cards[id].lastRefresh > 2000) {
                    refreshCrop(id);
                    cards[id].lastRefresh = now;
                }
            }

            document.getElementById('panel-count').textContent = attrIds.length;
        } catch (e) { /* ignore transient errors */ }
    }

    tick();
    setInterval(tick, 2000);
</script>
</body>
</html>
